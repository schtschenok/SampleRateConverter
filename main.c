// LLM-generated slop

#include "src.h"
#include <float.h>
#include <sndfile.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/* --- HARDCODED SETTINGS --- */
#define INPUT_FILE_PATH "input.wav"
// Interpolation factor (Upsampling)
#define NUM_TAPS_PER_PHASE 64

int main(void) {
    // ============================================================
    // 1. SETUP & FILENAME GENERATION
    // ============================================================
    const char* in_filename = INPUT_FILE_PATH;
    char out_filename[256];
    const char* ext = strrchr(in_filename, '.');
    size_t base_len = ext ? (size_t)(ext - in_filename) : strlen(in_filename);
    strncpy(out_filename, in_filename, base_len);
    out_filename[base_len] = '\0';
    strcat(out_filename, "_resampled.wav");

    printf("Processing: %s -> %s\n", in_filename, out_filename);
    printf("Rate Change: %d", 4);

    // ============================================================
    // 2. PHASE I: FULL FILE LOADING
    // ============================================================
    SF_INFO sf_in_info = { 0 };
    SNDFILE* infile = sf_open(in_filename, SFM_READ, &sf_in_info);

    if (!infile) {
        printf("Error: Could not open input file '%s'\n", in_filename);
        puts(sf_strerror(NULL));
        return 1;
    }

    if (sf_in_info.channels != 1) {
        printf("Error: Input must be Mono (1 channel). Found %d.\n", sf_in_info.channels);
        sf_close(infile);
        return 1;
    }

    // Calculate total size and allocate full input buffer
    sf_count_t input_frame_count = sf_in_info.frames;
    float* full_input_buffer = (float*)malloc(input_frame_count * sizeof(float));

    if (!full_input_buffer) {
        printf("Error: Memory allocation failed for input buffer.\n");
        sf_close(infile);
        return 1;
    }

    // Read the entire file into memory
    sf_count_t read_count = sf_read_float(infile, full_input_buffer, input_frame_count);

    // Close input file immediately (Separation of concerns)
    sf_close(infile);

    if (read_count != input_frame_count) {
        printf("Warning: Expected %ld frames, read %ld.\n", (long)input_frame_count, (long)read_count);
    }

    // ============================================================
    // 3. PHASE II: RESAMPLING (IN MEMORY)
    // ============================================================

    // A. Init Library
    int num_taps = NUM_TAPS_PER_PHASE * 4;

    float* coefficients = src_generate_fir_coeffs(num_taps);
    if (!coefficients) {
        printf("Error: Failed to generate FIR coefficients.\n");
        free(full_input_buffer);
        return 1;
    }

    float* pfb = src_generate_fir_filter(coefficients, num_taps);
    printf("\n");
        printf("\n");
    for (int i = 0; i < num_taps; i++) {
        printf("%.*e, ", DECIMAL_DIG - 1, pfb[i]);
    }
    printf("\n");
        printf("\n");
    free(coefficients); // No longer needed

    // if (!pfb) {
    //     printf("Error: Failed to generate FIR filter.\n");
    //     free(full_input_buffer);
    //     return 1;
    // }

    // B. Allocate Full Output Buffer
    // Calculate theoretical output size
    sf_count_t max_output_frames = read_count * 4; // +16 for safety padding
    float* full_output_buffer = (float*)malloc(max_output_frames * sizeof(float));

    if (!full_output_buffer) {
        printf("Error: Memory allocation failed for output buffer.\n");
        free(full_input_buffer);
        free(pfb);
        return 1;
    }

    // C. Process Single Block
    // We pass the entire input buffer count cast to int (assuming file fits in int range as per src_filt signature)

    // float pfb1[] = { -0.00000192842435354, 0.00001094197159546, -0.00002837526699295, 0.00005580418655882, -0.00009529479575576, 0.00014943820133340, -0.00022138313215692, 0.00031484520877711, -0.00043414824176580, 0.00058423564769328, -0.00077070429688320, 0.00099985883571208, -0.00127875141333789, 0.00161535665392876, -0.00201866612769663, 0.00249904510565102, -0.00306863011792302, 0.00374186597764492, -0.00453662406653166, 0.00547564635053277, -0.00658871605992317, 0.00791674014180899, -0.00951773673295975, 0.01147810369729996, -0.01393262483179569, 0.01710466481745243, -0.02139352448284626, 0.02758770994842052, -0.03748950734734535, 0.05630044266581535, -0.10773268342018127, 0.97443479299545288, 0.13878969848155975, -0.06406231224536896, 0.04099467024207115, -0.02960422635078430, 0.02271840162575245, -0.01805057562887669, 0.01464674621820450, -0.01203863974660635, 0.00996990874409676, -0.00828860979527235, 0.00689863460138440, -0.00573622388765216, 0.00475684180855751, -0.00392836239188910, 0.00322658964432776, -0.00263256276957691, 0.00213109026663005, -0.00170955061912537, 0.00135716167278588, -0.00106462067924440, 0.00082372745964676, -0.00062721630092710, 0.00046857973211445, -0.00034206605050713, 0.00024257125915028, -0.00016562052769586, 0.00010734374518506, -0.00006445482722484, 0.00003422357258387, -0.00001445739144401, 0.00000346132219420, -0.00000000000000000, -0.00000205042329071, 0.00001919436181197, -0.00005588782005361, 0.00011565465683816, -0.00020317864255048, 0.00032439164351672, -0.00048654590500519, 0.00069827656261623, -0.00096964591648430, 0.00131220882758498, -0.00173907494172454, 0.00226500839926302, -0.00290659116581082, 0.00368244876153767, -0.00461366213858128, 0.00572435231879354, -0.00704255932942033, 0.00860166363418102, -0.01044247299432755, 0.01261638756841421, -0.01519052498042583, 0.01825574971735477, -0.02193990908563137, 0.02643096446990967, -0.03201856464147568, 0.03917513415217400, -0.04872744157910347, 0.06226309016346931, -0.08326004445552826, 0.12106886506080627, -0.21227122843265533, 0.78377419710159302, 0.46979647874832153, -0.17907780408859253, 0.10899293422698975, -0.07697647809982300, 0.05836705863475800, -0.04604730382561684, 0.03720226883888245, -0.03049728646874428, 0.02521900832653046, -0.02095189131796360, 0.01743721775710583, -0.01450501289218664, 0.01203833054751158, -0.00995327252894640, 0.00818722695112228, -0.00669182930141687, 0.00542839895933867, -0.00436503579840064, 0.00347478664480150, -0.00273437309078872, 0.00212336424738169, -0.00162367557641119, 0.00121920194942504, -0.00089560670312494, 0.00064017070690170, -0.00044172166963108, 0.00029055666527711, -0.00017839294741862, 0.00009831420175033, -0.00004470806379686, 0.00001318919385085, -0.00000050822023923, -0.00000050822023923, 0.00001318919385085, -0.00004470806379686, 0.00009831420175033, -0.00017839294741862, 0.00029055666527711, -0.00044172166963108, 0.00064017070690170, -0.00089560670312494, 0.00121920194942504, -0.00162367557641119, 0.00212336424738169, -0.00273437309078872, 0.00347478664480150, -0.00436503579840064, 0.00542839895933867, -0.00669182930141687, 0.00818722695112228, -0.00995327252894640, 0.01203833054751158, -0.01450501289218664, 0.01743721775710583, -0.02095189131796360, 0.02521900832653046, -0.03049728646874428, 0.03720226883888245, -0.04604730382561684, 0.05836705863475800, -0.07697647809982300, 0.10899293422698975, -0.17907780408859253, 0.46979647874832153, 0.78377419710159302, -0.21227122843265533, 0.12106886506080627, -0.08326004445552826, 0.06226309016346931, -0.04872744157910347, 0.03917513415217400, -0.03201856464147568, 0.02643096446990967, -0.02193990908563137, 0.01825574971735477, -0.01519052498042583, 0.01261638756841421, -0.01044247299432755, 0.00860166363418102, -0.00704255932942033, 0.00572435231879354, -0.00461366213858128, 0.00368244876153767, -0.00290659116581082, 0.00226500839926302, -0.00173907494172454, 0.00131220882758498, -0.00096964591648430, 0.00069827656261623, -0.00048654590500519, 0.00032439164351672, -0.00020317864255048, 0.00011565465683816, -0.00005588782005361, 0.00001919436181197, -0.00000205042329071, -0.00000000000000000, 0.00000346132219420, -0.00001445739144401, 0.00003422357258387, -0.00006445482722484, 0.00010734374518506, -0.00016562052769586, 0.00024257125915028, -0.00034206605050713, 0.00046857973211445, -0.00062721630092710, 0.00082372745964676, -0.00106462067924440, 0.00135716167278588, -0.00170955061912537, 0.00213109026663005, -0.00263256276957691, 0.00322658964432776, -0.00392836239188910, 0.00475684180855751, -0.00573622388765216, 0.00689863460138440, -0.00828860979527235, 0.00996990874409676, -0.01203863974660635, 0.01464674621820450, -0.01805057562887669, 0.02271840162575245, -0.02960422635078430, 0.04099467024207115, -0.06406231224536896, 0.13878969848155975, 0.97443479299545288, -0.10773268342018127, 0.05630044266581535, -0.03748950734734535, 0.02758770994842052, -0.02139352448284626, 0.01710466481745243, -0.01393262483179569, 0.01147810369729996, -0.00951773673295975, 0.00791674014180899, -0.00658871605992317, 0.00547564635053277, -0.00453662406653166, 0.00374186597764492, -0.00306863011792302, 0.00249904510565102, -0.00201866612769663, 0.00161535665392876, -0.00127875141333789, 0.00099985883571208, -0.00077070429688320, 0.00058423564769328, -0.00043414824176580, 0.00031484520877711, -0.00022138313215692, 0.00014943820133340, -0.00009529479575576, 0.00005580418655882, -0.00002837526699295, 0.00001094197159546, -0.00000192842435354 };
    src_filt(num_taps, pfb, full_input_buffer, (int)read_count, full_output_buffer);

    // ============================================================
    // 4. PHASE III: FILE SAVING
    // ============================================================
    SF_INFO sf_out_info = sf_in_info;
    sf_out_info.samplerate = sf_in_info.samplerate * 4;
    sf_out_info.frames = max_output_frames;

    SNDFILE* outfile = sf_open(out_filename, SFM_WRITE, &sf_out_info);
    if (!outfile) {
        printf("Error: Could not create output file '%s'\n", out_filename);
        puts(sf_strerror(NULL));
        // Cleanup happens below
    } else {
        sf_write_float(outfile, full_output_buffer, max_output_frames);
        sf_close(outfile);
        printf("Saved: %s\n", out_filename);
    }

    // ============================================================
    // 5. CLEANUP
    // ============================================================
    free(full_input_buffer);
    free(full_output_buffer);

    if (pfb)
        free(pfb);

    return 0;
}
